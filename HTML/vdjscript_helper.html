<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VirtualDJ - VDJscript helper</title>
    <!-- include the stylesheet file -->
    <link rel="stylesheet" href="../css/style.css" type="text/css">
    <script src="../js/vdjscript_list.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <h1>VirtualDJ - VDJscript helper</h1>
    <div class="introduction">
        <a href="https://www.virtualdj.com/wiki/VDJscript.html" target="_blank">VDJscript documentation</a>
        <br />
        <a href="https://www.virtualdj.com/manuals/virtualdj/appendix/vdjscriptverbs.html" target="_blank">VDJscript List of verbs</a>
        <br />
        <a href="https://www.virtualdj.com/wiki/VDJScript%20Examples.html" target="_blank">Examples</a>
    </div>
    <br />

    <div class="container">
        <div class="vdjscript_action-bar">
            <label for="action">Action</label>
            <input type="text" id="action" readonly>
        </div>
        <div class="vdjscriptlist_container">
            <div class="vdjscriptlist_column">
                <h3>Category</h3>
                <ul class="vdjscriptlist_column_data" id="vdjscriptlist_category"></ul>
            </div>
            <div class="vdjscriptlist_column">
                <h3>Action</h3>
                <ul class="vdjscriptlist_column_data" id="vdjscriptlist_action"></ul>
            </div>
            <div class="vdjscriptlist_column">
                <h3>Description</h3>
                <div class="vdjscriptlist_description" id="vdjscriptlist_description">Select an action to see its description.</div>
            </div>
        </div>
        <br />
        <label id="vdjbuildlabel">...</label>
        <br />
        <br />
        <button onclick="ExportCSV()">Export list in CSV</button>
        <button onclick="ExportExcel()">Export list in Excel</button>
        <button onclick="ExportXML()">Export list in XML</button>
        <button onclick="ExportJSON()">Export list in JSON</button>
        <button onclick="ExportHTML()">Export list in HTML</button>
    </div>
    <script>
        const vdjbuildLabel = document.getElementById("vdjbuildlabel");
        const categoryList = document.getElementById("vdjscriptlist_category");
        const actionList = document.getElementById("vdjscriptlist_action");
        const descriptionBox = document.getElementById("vdjscriptlist_description");
        const actionInput = document.getElementById("action");

        const vdjbuildNo = vdjscript_list["VdjBuild"];
        vdjbuildLabel.textContent = "List of verbs based on VirtualDJ build " + vdjbuildNo

        // vdjdata structure: category → action → description
        const vdjdata = vdjscript_list["Items"];

        // Load categories
        Object.keys(vdjdata).forEach(cat => {
            const li = document.createElement("li");
            li.textContent = cat;
            li.addEventListener("click", () => selectCategory(cat, li));
            categoryList.appendChild(li);
        });

        function selectCategory(category, element) {
            // Highlight selected category
            [...categoryList.children].forEach(li => li.classList.remove("active"));
            element.classList.add("active");

            // Clear action + description
            actionList.innerHTML = "";
            descriptionBox.textContent = "Select an action to see its description.";
            actionInput.value = "";

            // Load actions for this category
            Object.keys(vdjdata[category]).forEach(act => {
                const li = document.createElement("li");
                li.textContent = act;
                li.addEventListener("click", () => selectAction(category, act, li));
                actionList.appendChild(li);
            });
        }

        function selectAction(category, action, element) {
            // Highlight selected action
            [...actionList.children].forEach(li => li.classList.remove("active"));
            element.classList.add("active");

            // Update description + input
            descriptionBox.textContent = vdjdata[category][action];
            actionInput.value = action;
        }

        function ExportCSV() {
            let rows = [["Category", "Action", "Alias", "Description"]];

            Object.keys(vdjdata).forEach(category => {
                Object.keys(vdjdata[category]).forEach(action => {
                    let description_full = vdjdata[category][action]
                    let parts = description_full.split("\n\n-----Alias-----\n");
                    let description_tmp = parts[0] ? parts[0].trim() : "";
                    let alias_tmp1 = parts[1] ? parts[1].trim() : "";
                    let alias_tmp2 = alias_tmp1.replaceAll("\n", "|");
                    let description = description_tmp.replace(/"/g, '""'); // escape quotes for CSV
                    let alias = alias_tmp2.replace(/"/g, '""'); // escape quotes for CSV
                    let row_data = [category, action, alias, description]
                    rows.push(row_data);
                });
            });

            // Convert array to CSV string
            let csvContent = rows.map(e => e.map(v => `"${v}"`).join(";")).join("\n");

            // Create downloadable blob
            let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            let url = URL.createObjectURL(blob);

            // Create temporary download link
            let link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "vdjscript_list.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function ExportExcel() {
            let rows = [["Category", "Action", "Alias", "Description"]];
            Object.keys(vdjdata).forEach(category => {
                Object.keys(vdjdata[category]).forEach(action => {
                    let description_full = vdjdata[category][action];
                    let parts = description_full.split("\n\n-----Alias-----\n");
                    let description = parts[0] ? parts[0].trim() : "";
                    let alias_tmp1 = parts[1] ? parts[1].trim() : "";
                    let alias = alias_tmp1.replaceAll("\n", "|");
                    let row_data = [category, action, alias, description];
                    rows.push(row_data);
                });
            });

            // Create worksheet from array
            let worksheet = XLSX.utils.aoa_to_sheet(rows);

            // Create new workbook and append worksheet
            let workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "VDJScript");

            // Export to Excel file
            XLSX.writeFile(workbook, "vdjscript_list.xlsx");
        }

        function ExportXML() {
            let xmlContent = `<?xml version="1.0" encoding="UTF-8"?>\n<VDJScriptList VdjBuild="` + vdjbuildNo + `">\n`;

            Object.keys(vdjdata).forEach(category => {
                Object.keys(vdjdata[category]).forEach(action => {
                    let description_full = vdjdata[category][action];
                    let parts = description_full.split("\n\n-----Alias-----\n");
                    let description = parts[0] ? parts[0].trim() : "";
                    let alias_tmp = parts[1] ? parts[1].trim() : "";
                    let alias = alias_tmp.replaceAll("\n", "|");

                    // Escape XML special characters
                    let escapeXml = (str) => str
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&apos;");

                    xmlContent += `  <Item>\n`;
                    xmlContent += `    <Category>${escapeXml(category)}</Category>\n`;
                    xmlContent += `    <Action>${escapeXml(action)}</Action>\n`;
                    xmlContent += `    <Alias>${escapeXml(alias)}</Alias>\n`;
                    xmlContent += `    <Description>${escapeXml(description)}</Description>\n`;
                    xmlContent += `  </Item>\n`;
                });
            });

            xmlContent += `</VDJScriptList>`;

            // Create downloadable blob
            let blob = new Blob([xmlContent], { type: "application/xml;charset=utf-8;" });
            let url = URL.createObjectURL(blob);

            // Create temporary download link
            let link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "vdjscript_list.xml");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function ExportJSON() {
            let items = [];

            Object.keys(vdjdata).forEach(category => {
                Object.keys(vdjdata[category]).forEach(action => {
                    let description_full = vdjdata[category][action];

                    let parts = description_full.split("\n\n-----Alias-----\n");
                    let description = parts[0] ? parts[0].trim() : "";
                    let alias_tmp = parts[1] ? parts[1].trim() : "";
                    let alias = alias_tmp.replaceAll("\n", "|");

                    items.push({
                        category: category,
                        action: action,
                        alias: alias,
                        description: description
                    });
                });
            });

            // Add vdjbuild before Items
            let jsonData = {
                VdjBuild: vdjbuildNo,
                Items: items
            };

            // Wrap in an object for clarity
            let jsonContent = JSON.stringify(jsonData, null, 2);

            // Create downloadable blob
            let blob = new Blob([jsonContent], { type: "application/json;charset=utf-8;" });
            let url = URL.createObjectURL(blob);

            // Create temporary download link
            let link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "vdjscript_list.json");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function ExportHTML() {
            let htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                  <meta charset="UTF-8">
                  <title>VDJScript List</title>
                  <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h1 { color: #333; }
                    table { border-collapse: collapse; width: 100%; }
                    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    tr:nth-child(even) { background-color: #fafafa; }
                  </style>
                </head>
                <body>
                  <h1>VDJScript List (VdjBuild ${vdjbuildNo})</h1>
                  <table>
                    <thead>
                      <tr>
                        <th>Category</th>
                        <th>Action</th>
                        <th>Alias</th>
                        <th>Description</th>
                      </tr>
                    </thead>
                    <tbody>
                `;

                Object.keys(vdjdata).forEach(category => {
                    Object.keys(vdjdata[category]).forEach(action => {
                        let description_full = vdjdata[category][action];
                        let parts = description_full.split("\n\n-----Alias-----\n");
                        let description = parts[0] ? parts[0].trim() : "";
                        let alias_tmp = parts[1] ? parts[1].trim() : "";
                        let alias = alias_tmp.replaceAll("\n", " | ");

                        // Escape HTML entities
                        let escapeHtml = (str) => str
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/"/g, "&quot;")
                            .replace(/'/g, "&#039;");

                        htmlContent += `
                  <tr>
                    <td>${escapeHtml(category)}</td>
                    <td>${escapeHtml(action)}</td>
                    <td>${escapeHtml(alias)}</td>
                    <td>${escapeHtml(description)}</td>
                  </tr>`;
                            });
                        });

                        htmlContent += `
                </tbody>
              </table>
            </body>
            </html>
            `;

            // Create downloadable blob
            let blob = new Blob([htmlContent], { type: "text/html;charset=utf-8;" });
            let url = URL.createObjectURL(blob);

            // Create temporary download link
            let link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "vdjscript_list.html");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>