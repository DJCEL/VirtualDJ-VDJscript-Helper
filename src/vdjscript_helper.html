<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VirtualDJ - VDJscript helper</title>
    <!-- include the stylesheet files (.css) -->
    <link rel="stylesheet" href="./css/style.css" type="text/css">
    <!-- include the javascript files (.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="./js/vdjscript_list.js" onerror="alert('vdjscript_list.js failed to load!')"></script>
</head>
<body>
    <h1>VirtualDJ - VDJscript helper</h1>
    <div class="introduction">
        <a href="https://www.virtualdj.com/wiki/VDJscript.html" target="_blank">VDJscript documentation</a>
        <br />
        <a href="https://www.virtualdj.com/manuals/virtualdj/appendix/vdjscriptverbs.html" target="_blank">VDJscript List of verbs</a>
        <br />
        <a href="https://www.virtualdj.com/wiki/VDJScript%20Examples.html" target="_blank">Examples</a>
    </div>
    <br />

    <div class="container">
        <div class="vdjscript_action-bar">
            <label for="action">Action</label>
            <input type="text" id="action" readonly>
        </div>
        <div class="vdjscriptlist_container">
            <div class="vdjscriptlist_column">
                <h3>Category</h3>
                <ul class="vdjscriptlist_column_data" id="vdjscriptlist_category"></ul>
            </div>
            <div class="vdjscriptlist_column">
                <h3>Action</h3>
                <ul class="vdjscriptlist_column_data" id="vdjscriptlist_action"></ul>
            </div>
            <div class="vdjscriptlist_column">
                <h3>Description</h3>
                <div class="vdjscriptlist_description" id="vdjscriptlist_description">Select an action to see its description.</div>
            </div>
        </div>
        <br />
        <label id="vdjbuildlabel">...</label>
        <br />
        <br />
        <button onclick="ExportCSV()">Export list in CSV</button>
        <button onclick="ExportExcel()">Export list in Excel</button>
        <button onclick="ExportXML()">Export list in XML</button>
        <button onclick="ExportJSON()">Export list in JSON</button>
        <button onclick="ExportHTML()">Export list in HTML</button>
    </div>

    <script type="text/javascript">
        const vdjbuildLabel = document.getElementById("vdjbuildlabel");
        const categoryList = document.getElementById("vdjscriptlist_category");
        const actionList = document.getElementById("vdjscriptlist_action");
        const descriptionBox = document.getElementById("vdjscriptlist_description");
        const actionInput = document.getElementById("action");

        const vdjbuildNo = vdjscript_list["VdjBuild"];
        vdjbuildLabel.textContent = "List of verbs based on VirtualDJ build " + vdjbuildNo

        // vdjdata structure: category → action → description
        const vdjdata = vdjscript_list["Items"];

        // Load categories
        Object.keys(vdjdata).forEach(cat => {
            const li = document.createElement("li");
            li.textContent = cat;
            li.addEventListener("click", () => selectCategory(cat, li));
            categoryList.appendChild(li);
        });

        function selectCategory(category, element) {
            // Highlight selected category
            [...categoryList.children].forEach(li => li.classList.remove("active"));
            element.classList.add("active");

            // Clear action + description
            actionList.innerHTML = "";
            descriptionBox.textContent = "Select an action to see its description.";
            actionInput.value = "";

            // Load actions for this category
            Object.keys(vdjdata[category]).forEach(act => {
                const li = document.createElement("li");
                li.textContent = act;
                li.addEventListener("click", () => selectAction(category, act, li));
                actionList.appendChild(li);
            });
        }

        function selectAction(category, action, element) {
            // Highlight selected action
            [...actionList.children].forEach(li => li.classList.remove("active"));
            element.classList.add("active");

            // Update description + input
            let action_data = vdjdata[category][action];
            var description = action_data.description;
            var alias = (action_data.alias) ? action_data.alias.replace("|", "\n") : "";
            var description_full = (alias != "") ? description + "\n\n--- ALIAS ---\n" + alias : description;
            descriptionBox.textContent = description_full;
            actionInput.value = action;
        }

        function ExportCSV() {
            let csvSeparator = ",";
            let rows = [["Category", "Action", "Alias", "Description"]];

            Object.keys(vdjdata).forEach(category => {
                Object.keys(vdjdata[category]).forEach(action => {
                    let action_data = vdjdata[category][action]
                    let description_tmp = action_data.description.replace("TODO", "");
                    let alias_tmp = (action_data.alias) ? action_data.alias : "";
                    let description = description_tmp.replace(/"/g, '""');
                    let alias = alias_tmp.replace(/"/g, '""');
                    let row_data = [category, action, alias, description]
                    rows.push(row_data);
                });
            });

            let csvContent = rows.map(e => e.map(v => `"${v}"`).join(csvSeparator)).join("\n");
            let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            let url = URL.createObjectURL(blob);
            let link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "vdjscript_list.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function ExportExcel() {
            let rows = [["Category", "Action", "Alias", "Description"]];
            Object.keys(vdjdata).forEach(category => {
                Object.keys(vdjdata[category]).forEach(action => {
                    let action_data = vdjdata[category][action]
                    let description = action_data.description.replace("TODO", "");
                    let alias = (action_data.alias) ? action_data.alias : "";
                    let row_data = [category, action, alias, description];
                    rows.push(row_data);
                });
            });

            let worksheet = XLSX.utils.aoa_to_sheet(rows);
            let workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "VDJScript");
            XLSX.writeFile(workbook, "vdjscript_list.xlsx");
        }

        function ExportXML() {
            let xmlContent = `<?xml version="1.0" encoding="UTF-8"?>\n<VDJScriptList VdjBuild="` + vdjbuildNo + `">\n`;

            Object.keys(vdjdata).forEach(category => {
                Object.keys(vdjdata[category]).forEach(action => {
                    let action_data = vdjdata[category][action]
                    let description = action_data.description.replace("TODO", "");
                    let alias = (action_data.alias) ? action_data.alias : "";

                    // Escape XML special characters
                    let escapeXml = (str) => str
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&apos;");

                    xmlContent += `  <Item>\n`;
                    xmlContent += `    <Category>${escapeXml(category)}</Category>\n`;
                    xmlContent += `    <Action>${escapeXml(action)}</Action>\n`;
                    if (alias != "") {
                        xmlContent += `    <Alias>${escapeXml(alias)}</Alias>\n`;
                    }
                    if (description != "") {
                        xmlContent += `    <Description>${escapeXml(description)}</Description>\n`;
                    }
                    xmlContent += `  </Item>\n`;
                });
            });

            xmlContent += `</VDJScriptList>`;
            let blob = new Blob([xmlContent], { type: "application/xml;charset=utf-8;" });
            let url = URL.createObjectURL(blob);
            let link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "vdjscript_list.xml");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function ExportJSON() {
            let items = [];

            Object.keys(vdjdata).forEach(category => {
                Object.keys(vdjdata[category]).forEach(action => {
                    let action_data = vdjdata[category][action]
                    let description = action_data.description.replace("TODO", "");
                    let alias = (action_data.alias) ? action_data.alias : "";

                    let itemData = { category, action };
                    if (description !== "") {
                        itemData.description = description;
                    }
                    if (alias !== "") {
                        itemData.alias = alias;
                    }

                    items.push(itemData);
                });
            });

            let jsonData = {
                VdjBuild: vdjbuildNo,
                Items: items
            };

            let jsonContent = JSON.stringify(jsonData, null, 2);
            let blob = new Blob([jsonContent], { type: "application/json;charset=utf-8;" });
            let url = URL.createObjectURL(blob);
            let link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "vdjscript_list.json");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function ExportHTML() {
            let htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>VDJScript List</title>
                        <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { color: #333; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        tr:nth-child(even) { background-color: #fafafa; }
                        </style>
                    </head>
                    <body>
                        <h1>VDJScript List (VdjBuild ${vdjbuildNo})</h1>
                        <table>
                        <thead>
                            <tr>
                            <th>Category</th>
                            <th>Action</th>
                            <th>Alias</th>
                            <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;

            Object.keys(vdjdata).forEach(category => {
                Object.keys(vdjdata[category]).forEach(action => {
                    let action_data = vdjdata[category][action]
                    let description = action_data.description.replace("TODO", "");
                    let alias = (action_data.alias) ? action_data.alias : "";

                    let escapeHtml = (str) => str
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");

                    htmlContent += `
                        <tr>
                        <td>${escapeHtml(category)}</td>
                        <td>${escapeHtml(action)}</td>
                        <td>${escapeHtml(alias)}</td>
                        <td>${escapeHtml(description)}</td>
                        </tr>`;
                });
            });

            htmlContent += `
                    </tbody>
                    </table>
                </body>
                </html>
                `;

            let blob = new Blob([htmlContent], { type: "text/html;charset=utf-8;" });
            let url = URL.createObjectURL(blob);
            let link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "vdjscript_list.html");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>








